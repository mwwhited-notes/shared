@startuml RaptorQ Encoding Decoding Flow
skinparam backgroundColor #FEFEFE
skinparam defaultFontName Helvetica
skinparam defaultFontSize 10
skinparam sequenceArrowThickness 2

title RaptorQ Encoder Decoder Sequence (RFC 6330)

participant "Sender" as sender
participant "RaptorQ Encoder" as encoder
participant "Network (Lossy)" as network
participant "Receiver 1" as rx1
participant "Receiver 2" as rx2
participant "RaptorQ Decoder" as decoder

autonumber

sender -> encoder: ReadFile(K symbols)
note right of encoder
  Symbol Count = K
  Redundancy = 20%
  Repair Symbols = 0.2*K
end note

encoder -> encoder: GenerateSourceBlock

loop Generate Symbols
    encoder -> network: SendSymbol(ISI, payload)
end

note right of network
  Simulating 20% packet loss
  Packets arrive out-of-order
  Delay = variable
end note

network -> rx1: RecvSymbol(ISI=0)
network -> rx1: RecvSymbol(ISI=5)
network -> rx1: RecvSymbol(ISI=12)
network -> rx2: RecvSymbol(ISI=3)
network -> rx2: RecvSymbol(ISI=7)
network -> rx2: RecvSymbol(ISI=15)

rx1 -> decoder: AddSymbol(ISI=0, data)
rx1 -> decoder: AddSymbol(ISI=5, data)
rx1 -> decoder: AddSymbol(ISI=12, data)

rx2 -> decoder: AddSymbol(ISI=3, data)
rx2 -> decoder: AddSymbol(ISI=7, data)
rx2 -> decoder: AddSymbol(ISI=15, data)

decoder -> decoder: CheckIfDecoded()
note left of decoder
  Received 6 symbols
  Required K >= 5
  Ready to decode
end note

decoder -> decoder: SolveGaussianElimination

decoder -> decoder: RecoverSourceSymbols

decoder --> sender: WriteFile(K symbols)

note right of decoder
  Recovery complete
  From 6 received symbols
  Recovered all K source symbols
  With less than 20% overhead
end note

autonumber stop

@enduml
