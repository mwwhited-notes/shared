@startuml LSL Stream Synchronization Flow
skinparam backgroundColor #FEFEFE
skinparam defaultFontName Helvetica
skinparam defaultFontSize 10
skinparam sequenceArrowThickness 2

title LSL Multi-Stream Timestamp Synchronization

participant "EEG Stream 256Hz" as eeg
participant "ECG Stream 250Hz" as ecg
participant "Eye Tracker 120Hz" as eye
participant "LSL Hub" as hub
participant "Clock Synchronizer" as sync
participant "Recorder" as rec

autonumber

note over eeg, rec: T=0s All streams start

eeg -> hub: push_sample
note right of eeg
  data ch0 to ch255
  timestamp local_clock[0]
end note

ecg -> hub: push_sample
note right of ecg
  data I II III
  timestamp local_clock[0]
end note

eye -> hub: push_sample
note right of eye
  data x y confidence
  timestamp local_clock[0]
end note

note right of hub
  Each stream maintains:
  Sample buffer
  Timestamp info
  Nominal sample rate
  Clock offset estimate
end note

par Parallel Stream 1
    eeg -> eeg: Acquire 256 samples (t=1.0s)
    eeg -> hub: push_samples(batch)
else Parallel Stream 2
    ecg -> ecg: Acquire 250 samples (t=1.0s)
    ecg -> hub: push_samples(batch)
else Parallel Stream 3
    eye -> eye: Acquire 120 samples (t=1.0s)
    eye -> hub: push_samples(batch)
end

note over hub: Timestamp Registration Phase

loop Every 10 seconds
    hub -> sync: register_clock_offset for EEG
    hub -> sync: register_clock_offset for ECG
    hub -> sync: register_clock_offset for Eye
end

sync -> sync: ComputeClockOffsets
note right of sync
  Linear regression
  Detects clock drift
  Compensates offset
  Correlation greater than 99.5%
end note

hub -> rec: request_timestamps
note right of rec
  modal common_timebase
end note

rec -> sync: get_unified_timestamp
note right of rec
  stream_ids EEG ECG Eye
  local_samples 256t 250t 120t
end note

sync -> rec: return unified timestamps
note right of sync
  unified_ts
  offset_model y equals mx plus b
  confidence 0.9999
end note

note right of rec
  Recording Timestamp Assignment:
  Use unified timebase
  Linear interpolation
  Apply offsets and drift
  Store with metadata
end note

rec -> rec: WriteSynchronizedXDF
note right of rec
  all_streams_aligned
  common_timestamp_domain
  metadata offset_models
end note

note over eeg, rec: Result Multi-modal data synchronized to less than 1ms

@enduml
