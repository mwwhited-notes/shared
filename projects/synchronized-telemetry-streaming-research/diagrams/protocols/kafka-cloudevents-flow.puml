@startuml Kafka CloudEvents Message Flow
skinparam backgroundColor #FEFEFE
skinparam defaultFontName Helvetica
skinparam defaultFontSize 10
skinparam sequenceArrowThickness 2

title Kafka CloudEvents Message Flow (CNCF Standard)

participant "Event Producer" as prod
participant "Kafka Producer API" as ka
participant "Broker Partition" as broker
participant "Consumer Group" as cg
participant "Event Consumer" as cons

autonumber

prod -> prod: CreateCloudEvent
note right of prod
  specversion 1.0
  type com.sensor.data
  source /sensor/temp001
  id abc-123
  time 2025-01-16T10:30:45Z
  datacontenttype application/json
  payload {temp: 22.5, humidity: 65}
end note

prod -> ka: send(topic, key, value, headers)

ka -> broker: WriteRecord
note right of broker
  partition 0
  offset 12345
  key_len 19
  value_len 285
  timestamp Unix-ms
end note

broker -> broker: PersistToLog
note right of broker
  replication 3x
  min_isr 2
end note

broker -> cg: FetchRecords
note right of broker
  partition 0
  offset 12345
  max_records 100
end note

cg -> cons: onMessage
note right of cons
  event_headers
  event_body
  metadata
end note

cons -> cons: ParseCloudEvent
note right of cons
  verify_required_attrs
  parse_data_schema
end note

cons -> cons: ValidatePayload
note right of cons
  dataschema JSON-Schema
  result valid
end note

cons -> cons: ProcessEvent
note right of cons
  temp 22.5
  humidity 65
  room living_room
  timestamp 2025-01-16T10:30:45Z
end note

cons -> cons: EmitMetrics
note right of cons
  influxdb_point temp
  tags sensor/temp001,room
  fields value 22.5
end note

cg -> ka: commitOffset
note right of cg
  partition 0
  offset 12345
end note

ka -> broker: OffsetCommit
note right of broker
  consumer_group analytics
  offset_store __consumer_offsets
end note

note right of cons
  Benefits:
  Schema evolution safe
  Metadata standardized
  Cross-system interop
  Traceable
end note

note left of broker
  Scaling Strategy:
  Partitioning by source
  Consumer groups parallel
  Rebalancing transparent
end note

@enduml
